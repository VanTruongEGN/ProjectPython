{% extends "admin/base_site.html" %}
{% load static %}
{% load currency %}
{% load humanize %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'admin_dashboard/css/dashboard.css' %}">
{% endblock %}

{% block content %}

<h1>ğŸ“Š Dashboard quáº£n trá»‹ há»‡ thá»‘ng</h1>

<!-- ===== CHá»ŒN KIá»‚U THá»NG KÃŠ ===== -->
<div class="filter-box">
    <div style="display:flex; gap:15px;" class="header-site">

        <!-- ===== RADIO CHá»ŒN VIEW (Äá»”I URL) ===== -->
        <div class="radio-filter">
            <label>
                <input type="radio" name="view_type"
                       {% if view_type == 'day' %}checked{% endif %}
                       data-url="{% url 'dashboard_day' %}">
                Theo ngÃ y
            </label>

            <label>
                <input type="radio" name="view_type"
                       {% if view_type == 'year' %}checked{% endif %}
                       data-url="{% url 'dashboard_year' %}">
                Theo nÄƒm
            </label>

            <label>
                <input type="radio" name="view_type"
                       {% if view_type == 'event' %}checked{% endif %}
                       data-url="{% url 'dashboard_event' %}">
                Theo sá»± kiá»‡n
            </label>


        </div>

        <form method="get" class="option-filter" style="display:flex; gap:10px">
            {% if view_type == 'day' %}
                <div>
                    <label>Tá»« ngÃ y</label>
                    <input type="date" name="start_date" value="{{ start_date }}">
                </div>
                <div>
                    <label>Äáº¿n ngÃ y</label>
                    <input type="date" name="end_date" value="{{ end_date }}">
                </div>
            {% endif %}

            {% if view_type == 'year' %}
                <div>
                    <label>NÄƒm</label>
                    <select name="year">
                        {% for y in year_list %}
                            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}

            {% if view_type == 'event' %}
                <div>
                    <label>Sá»± kiá»‡n</label>
                    <div class="event-checkbox-list">
                        {% for e in promotions %}
                            <label>
                                <input type="checkbox"
                                       name="promotion_ids"
                                       value="{{ e.id }}"
                                       {% if e.id|stringformat:"s" in selected_promotion_ids %}checked{% endif %}>
                                {{ e.name }}
                            </label><br>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <button class="filter default">Lá»c</button>
        </form>
    </div>
</div>

{% if view_type == 'day' %}
<section class="dashboard-section">
    <h2>ğŸ“… Thá»‘ng kÃª theo ngÃ y</h2>

    <div class="dashboard-cards">
        <div class="card">
            {% if start_date and end_date %}
            {% if start_date == end_date %}
            <h3>ğŸ’° Doanh thu ngÃ y {{ start_date|date:"d/m/Y" }}</h3>
            {% else %}
            <h3>ğŸ’° Doanh thu tá»« {{ start_date|date:"d/m/Y" }} Ä‘áº¿n {{ end_date|date:"d/m/Y" }}</h3>
            {% endif %}
            {% elif start_date and not end_date %}
            <h3>ğŸ’° Doanh thu tá»« {{ start_date|date:"d/m/Y" }} trá»Ÿ Ä‘i</h3>
            {% elif not start_date and end_date %}
            <h3>ğŸ’° Doanh thu Ä‘áº¿n {{ end_date|date:"d/m/Y" }}</h3>
            {% else %}
            <h3>ğŸ’° Doanh thu hÃ´m nay</h3>
            {% endif %}
            <strong>{{ daily_revenue|vnd }}</strong>
        </div>
        <div class="card">
            <h3>ğŸ“¦ Tá»•ng Ä‘Æ¡n</h3>
            <strong>{{ daily_orders }}</strong>
        </div>
    </div>

    <h3>ğŸ”¥ Top sáº£n pháº©m bÃ¡n cháº¡y</h3>
    <table class="admin-table">
        <tr>
            <th>MÃ£ sáº£n pháº©m</th>
            <th>Sáº£n pháº©m</th>
            <th>Sá»‘ lÆ°á»£ng bÃ¡n</th>
        </tr>
        {% for p in daily_top_products %}
        <tr>
            <td>{{ p.product__id }}</td>
            <td>{{ p.product__name }}</td>
            <td>{{ p.total_sold }}</td>
        </tr>
        {% endfor %}
    </table>

    <h3>ğŸ‘‘ KhÃ¡ch hÃ ng mua nhiá»u nháº¥t</h3>
    <table class="admin-table">
        <tr>
            <th>KhÃ¡ch hÃ ng</th>
            <th>MÃ£ khÃ¡ch hÃ ng</th>
            <th>Sá»‘ Ä‘Æ¡n</th>
            <th>Tá»•ng chi</th>
        </tr>
        {% for c in daily_top_customers %}
        <tr>
            <td>{{ c.customer__id }}</td>
            <td>{{ c.customer__full_name }}</td>
            <td>{{ c.total_orders }}</td>
            <td>{{ c.total_spent|vnd }}</td>
        </tr>
        {% endfor %}
    </table>
</section>
{% endif %}

{% if view_type == 'year' %}
<section class="dashboard-section">
    <h2>ğŸ“† Thá»‘ng kÃª theo nÄƒm ({{ year }})</h2>

    <div class="dashboard-cards">
        <div class="card">
            <h3>ğŸ¦ Tá»•ng doanh thu</h3>
            <strong>{{ total_revenue|vnd }}</strong>
        </div>
        <div class="card">
            <h3>ğŸ“¦ Tá»•ng Ä‘Æ¡n</h3>
            <strong>{{ total_orders }}</strong>
        </div>
    </div>

    <h3>ğŸ“ˆ Doanh thu theo thÃ¡ng</h3>
    <canvas id="revenueChart" height="90"></canvas>

    <h3>ğŸ”¥ Top sáº£n pháº©m bÃ¡n cháº¡y</h3>
    <table class="admin-table">
        <tr>
            <th>MÃ£ sáº£n pháº©m</th>
            <th>Sáº£n pháº©m</th>
            <th>Sá»‘ lÆ°á»£ng bÃ¡n</th>
        </tr>
        {% for p in top_products %}
        <tr>
            <td>{{ p.product__id }}</td>
            <td>{{ p.product__name }}</td>
            <td>{{ p.total_sold }}</td>
        </tr>
        {% endfor %}
    </table>

    <h3>ğŸ‘‘ KhÃ¡ch hÃ ng mua nhiá»u nháº¥t</h3>
    <table class="admin-table">
        <tr>
            <th>KhÃ¡ch hÃ ng</th>
            <th>MÃ£ khÃ¡ch hÃ ng</th>
            <th>Sá»‘ Ä‘Æ¡n</th>
            <th>Tá»•ng chi</th>
        </tr>
        {% for c in top_customers %}
        <tr>
            <td>{{ c.customer__id }}</td>
            <td>{{ c.customer__full_name }}</td>
            <td>{{ c.total_orders }}</td>
            <td>{{ c.total_spent|vnd }}</td>
        </tr>
        {% endfor %}
    </table>
</section>
{% endif %}

{% if view_type == 'event' %}
<section class="dashboard-section">
    <h2>ğŸ¯ Thá»‘ng kÃª theo sá»± kiá»‡n</h2>

    {% if event_chart %}

        <div class="dashboard-cards">
            {% for s in event_stats %}
            <div class="card">
                <h3>{{ s.event.name }}</h3>
                <p>ğŸ“¦ Tá»•ng Ä‘Æ¡n: <strong>{{ s.total_orders }}</strong></p>
                <p>ğŸ’° Doanh thu: <strong>{{ s.revenue|vnd }}</strong></p>
            </div>
            {% endfor %}
        </div>

        <canvas id="eventRevenueChart" height="90" ></canvas>

    {% else %}
        <p>Vui lÃ²ng chá»n Ã­t nháº¥t 1 sá»± kiá»‡n</p>
    {% endif %}
</section>
{% endif %}

{% if view_type == 'year' %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
const ctx = document.getElementById('revenueChart');
if (ctx) {
    new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ month_labels|safe }},
            datasets: [{
                label: 'Doanh thu theo thÃ¡ng (Ä‘)',
                data: {{ month_values|safe }},
                backgroundColor: '#4CAF50'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#333',
                    font: { weight: 'bold', size: 12 },
                    formatter: function(value) {
                        if (value === 0) return '';
                        return value.toLocaleString() + ' Ä‘';
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: value => value.toLocaleString() + ' Ä‘'
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}
</script>
{% endif %}

{% if view_type == 'event' and event_chart %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
const ctxEvent = document.getElementById('eventRevenueChart');
if (ctxEvent) {
    new Chart(ctxEvent.getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ event_labels|safe }},
            datasets: [{
                label: 'Doanh thu theo sá»± kiá»‡n (Ä‘)',
                data: {{ event_values|safe }},
                backgroundColor: '#62ff00',
                barThickness:60,
                maxBarThickness:65,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: v => v.toLocaleString() + ' Ä‘'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: v => v.toLocaleString() + ' Ä‘'
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}
</script>
{% endif %}
<script>
    document.querySelectorAll('input[name="view_type"]').forEach(radio => {
        radio.addEventListener('change', function () {
            const url = this.dataset.url;
            if (url) {
                window.location.href = url;
            }
        });
    });
</script>

{% endblock %}
