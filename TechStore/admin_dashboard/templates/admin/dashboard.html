{% extends "admin/base_site.html" %}
{% load static %}
{% load currency %}
{% load humanize %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'admin_dashboard/css/dashboard.css' %}">
{% endblock %}

{% block content %}

<h1>ğŸ“Š Dashboard quáº£n trá»‹ há»‡ thá»‘ng</h1>

<!-- ===== CHá»ŒN KIá»‚U THá»NG KÃŠ ===== -->
<div class="filter-box">
    <form method="get" style="display:flex; gap:15px">
        <div class="radio-filter">
            <label>
                <input type="radio" name="view_type" value="day" {% if view_type == 'day' %}checked{% endif %}>
                Theo ngÃ y
            </label>
            <label>
                <input type="radio" name="view_type" value="year" {% if view_type == 'year' %}checked{% endif %}>
                Theo nÄƒm
            </label>
        </div>

        <div class="option-filter">
            <div {% if view_type != 'day' %}style="display:none"{% endif %}>
                <label>Tá»« ngÃ y</label>
                <input type="date" name="start_date" value="{{ start_date }}">
            </div>
            <div {% if view_type != 'day' %}style="display:none"{% endif %}>
                <label>Äáº¿n ngÃ y</label>
                <input type="date" name="end_date" value="{{ end_date }}" min="{{ start_date }}">
            </div>

            <div {% if view_type != 'year' %}style="display:none"{% endif %}>
                <label>NÄƒm thá»‘ng kÃª</label>
                <select name="year">
                    {% for y in year_list %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </div>
        <button class="button default">Lá»c</button>
        </div>
    </form>
</div>

<!-- ===== SECTION THEO NGÃ€Y ===== -->
{% if view_type == 'day' %}
<section class="dashboard-section">
    <h2>ğŸ“… Thá»‘ng kÃª theo ngÃ y</h2>

    <div class="dashboard-cards">
        <div class="card">
            {% if start_date == end_date %}
            <h3>ğŸ’° Doanh thu {{ start_date|date:"d/m/Y" }}</h3>
            {% else %}
            <h3>ğŸ’° Doanh thu tá»« {{ start_date|date:"d/m/Y" }} Ä‘áº¿n {{ end_date|date:"d/m/Y" }}</h3>
            {% endif %}
            <strong>{{ daily_revenue|vnd }}</strong>
        </div>
        <div class="card">
            <h3>ğŸ“¦ Tá»•ng Ä‘Æ¡n</h3>
            <strong>{{ daily_orders }}</strong>
        </div>
    </div>

    <h3>ğŸ”¥ Top sáº£n pháº©m bÃ¡n cháº¡y</h3>
    <table class="admin-table">
        <tr>
            <th>MÃ£ sáº£n pháº©m</th>
            <th>Sáº£n pháº©m</th>
            <th>Sá»‘ lÆ°á»£ng bÃ¡n</th>
        </tr>
        {% for p in daily_top_products %}
        <tr>
            <td>{{ p.product__id }}</td>
            <td>{{ p.product__name }}</td>
            <td>{{ p.total_sold }}</td>
        </tr>
        {% endfor %}
    </table>

    <h3>ğŸ‘‘ KhÃ¡ch hÃ ng mua nhiá»u nháº¥t</h3>
    <table class="admin-table">
        <tr>
            <th>KhÃ¡ch hÃ ng</th>
            <th>MÃ£ khÃ¡ch hÃ ng</th>
            <th>Sá»‘ Ä‘Æ¡n</th>
            <th>Tá»•ng chi</th>
        </tr>
        {% for c in daily_top_customers %}
        <tr>
            <td>{{ c.customer__id }}</td>
            <td>{{ c.customer__full_name }}</td>
            <td>{{ c.total_orders }}</td>
            <td>{{ c.total_spent|vnd }}</td>
        </tr>
        {% endfor %}
    </table>
</section>
{% endif %}

<!-- ===== SECTION THEO NÄ‚M ===== -->
{% if view_type == 'year' %}
<section class="dashboard-section">
    <h2>ğŸ“† Thá»‘ng kÃª theo nÄƒm ({{ year }})</h2>

    <div class="dashboard-cards">
        <div class="card">
            <h3>ğŸ¦ Tá»•ng doanh thu</h3>
            <strong>{{ total_revenue|vnd }}</strong>
        </div>
        <div class="card">
            <h3>ğŸ“¦ Tá»•ng Ä‘Æ¡n</h3>
            <strong>{{ total_orders }}</strong>
        </div>
    </div>

    <h3>ğŸ“ˆ Doanh thu theo thÃ¡ng</h3>
    <canvas id="revenueChart" height="90"></canvas>

    <h3>ğŸ”¥ Top sáº£n pháº©m bÃ¡n cháº¡y</h3>
    <table class="admin-table">
        <tr>
            <th>MÃ£ sáº£n pháº©m</th>
            <th>Sáº£n pháº©m</th>
            <th>Sá»‘ lÆ°á»£ng bÃ¡n</th>
        </tr>
        {% for p in top_products %}
        <tr>
            <td>{{ p.product__id }}</td>
            <td>{{ p.product__name }}</td>
            <td>{{ p.total_sold }}</td>
        </tr>
        {% endfor %}
    </table>

    <h3>ğŸ‘‘ KhÃ¡ch hÃ ng mua nhiá»u nháº¥t</h3>
    <table class="admin-table">
        <tr>
            <th>KhÃ¡ch hÃ ng</th>
            <th>MÃ£ khÃ¡ch hÃ ng</th>
            <th>Sá»‘ Ä‘Æ¡n</th>
            <th>Tá»•ng chi</th>
        </tr>
        {% for c in top_customers %}
        <tr>
            <td>{{ c.customer__id }}</td>
            <td>{{ c.customer__full_name }}</td>
            <td>{{ c.total_orders }}</td>
            <td>{{ c.total_spent|vnd }}</td>
        </tr>
        {% endfor %}
    </table>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
const ctx = document.getElementById('revenueChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ month_labels|safe }},
        datasets: [{
            label: 'Doanh thu theo thÃ¡ng (Ä‘)',
            data: {{ month_values|safe }},
            backgroundColor: '#4CAF50'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: true },
            datalabels: {
                anchor: 'end',
                align: 'top',
                color: '#333',
                font: { weight: 'bold', size: 12 },
                formatter: function(value) {
                    if (value === 0) return '';
                    return value.toLocaleString() + ' Ä‘';
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { callback: value => value.toLocaleString() + ' Ä‘' }
            }
        }
    },
    plugins: [ChartDataLabels]
});
</script>
{% endif %}

<script>
// ===== JS tá»± Ä‘á»™ng show/áº©n filter theo radio =====
const radios = document.querySelectorAll('input[name="view_type"]');
radios.forEach(radio => {
    radio.addEventListener('change', () => {
        location.search = `view_type=${radio.value}`;
    });
});
</script>

{% endblock %}
