{% extends "admin/base_site.html" %}
{% load static %}
{% load currency %}
{% load humanize %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'admin_dashboard/css/dashboard.css' %}">
{% endblock %}

{% block content %}


<h1>ğŸ“Š Dashboard quáº£n trá»‹ há»‡ thá»‘ng</h1>

<!-- ===== FILTER ===== -->
<div class="filter-box">
    <form method="get" style="display:flex; gap:15px; align-items:end;">
        <div>
            <label>Tá»« ngÃ y</label>
            <input type="date" name="start_date" value="{{ start_date }}">
        </div>
        <div>
            <label>Äáº¿n ngÃ y</label>
            <input type="date" name="end_date" value="{{ end_date }}">
        </div>
        <div>
            <label>NÄƒm thá»‘ng kÃª</label>
            <select name="year">
                {% for y in year_list %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>
                    {{ y }}
                </option>
                {% endfor %}
            </select>
        </div>
        <button class="button default">Lá»c</button>
    </form>
</div>

<div class="dashboard-cards">
    <div class="card">
        <h3>ğŸ’° Doanh thu hÃ´m nay</h3>
        <strong>{{ today_revenue|vnd }}</strong>
    </div>
    <div class="card">
        <h3>ğŸ“¦ Tá»•ng Ä‘Æ¡n</h3>
        <strong>{{ total_orders }}</strong>
    </div>
    <div class="card">
        <h3>ğŸ¦ Tá»•ng doanh thu</h3>
        <strong>{{ total_revenue|vnd }}</strong>
    </div>
</div>

<h2>ğŸ“ˆ Doanh thu theo thÃ¡ng ({{ year }})</h2>
<canvas id="revenueChart" height="90"></canvas>

<hr>

<!-- ===== TOP Sáº¢N PHáº¨M ===== -->
<h2>ğŸ”¥ Top sáº£n pháº©m bÃ¡n cháº¡y</h2>
<table class="admin-table">
    <tr>
        <th>MÃ£ sáº£n pháº©m</th>
        <th>Sáº£n pháº©m</th>
        <th>Sá»‘ lÆ°á»£ng bÃ¡n</th>
    </tr>
    {% for p in top_products %}
    <tr>
        <td>{{ p.product__id }}</td>
        <td>{{ p.product__name }}</td>
        <td>{{ p.total_sold }}</td>
    </tr>
    {% endfor %}
</table>

<hr>

<!-- ===== TOP KHÃCH HÃ€NG ===== -->
<h2>ğŸ‘‘ KhÃ¡ch hÃ ng mua nhiá»u nháº¥t</h2>
<table class="admin-table">
    <tr>
        <th>KhÃ¡ch hÃ ng</th>
        <th>MÃ£ khÃ¡ch hÃ ng</th>
        <th>Sá»‘ Ä‘Æ¡n</th>
        <th>Tá»•ng chi</th>
    </tr>
    {% for c in top_customers %}
    <tr>
        <td>{{ c.customer__id }}</td>
        <td>{{ c.customer__full_name }}</td>
        <td>{{ c.total_orders }}</td>
        <td>{{ c.total_spent|vnd }}</td>
    </tr>
    {% endfor %}
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


<script>
const ctx = document.getElementById('revenueChart').getContext('2d');

new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ month_labels|safe }},
        datasets: [{
            label: 'Doanh thu theo thÃ¡ng (Ä‘)',
            data: {{ month_values|safe }},
            backgroundColor: '#4CAF50'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: true },

            // ===== HIá»‚N THá»Š Sá» TRÃŠN Äáº¦U Cá»˜T =====
            datalabels: {
                anchor: 'end',
                align: 'top',
                color: '#333',
                font: {
                    weight: 'bold',
                    size: 12
                },
                formatter: function(value) {
                    if (value === 0) return '';
                    return value.toLocaleString() + ' Ä‘';
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: value => value.toLocaleString() + ' Ä‘'
                }
            }
        }
    },
    plugins: [ChartDataLabels]
});
</script>


{% endblock %}
